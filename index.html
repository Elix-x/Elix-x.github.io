<!doctype html>
<html>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
/**
 * Returns a number whose value is limited to the given range.
 *
 * Example: limit the output of this computation to between 0 and 255
 * (x * 255).clamp(0, 255)
 *
 * @param {Number} min The lower boundary of the output range
 * @param {Number} max The upper boundary of the output range
 * @returns A number in the range [min, max]
 * @type Number
 */
Number.prototype.clamp = function(min, max){
  return Math.min(Math.max(this, min), max)
}

function getUrlQueryParam(name, url){
	if(!url) url = window.location.href;
	name = name.replace(/[\[\]]/g, "\\$&");
	var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
		results = regex.exec(url);
	if(!results) return null;
	if(!results[2]) return '';
	return decodeURIComponent(results[2].replace(/\+/g, " "));
}

function setUrlQueryParam(key, value){
	baseUrl = [location.protocol, '//', location.host, location.pathname].join('');
	urlQueryString = document.location.search;
	var newParam = key + '=' + value,
		params = '?' + newParam;

	// If the "search" string exists, then build params from it
	if(urlQueryString){
		keyRegex = new RegExp('([\?&])' + key + '[^&]*');
		// If param exists already, update it
		if(urlQueryString.match(keyRegex) !== null){
			params = urlQueryString.replace(keyRegex, "$1" + newParam);
		} else { // Otherwise, add it to end of query string
			params = urlQueryString + '&' + newParam;
		}
	}
	window.history.replaceState({}, "", baseUrl + params);
}
</script>
<script>
//Logo

var logoed = true
function getLogo(){
	return $(".logo").get()[0];
}
function onLogoClick(logo){
	logoem()
}
function logoem(){
	logo = getLogo()
	if(logoed) return;
	logo.classList.toggle("logo")
	logo.classList.toggle("logo-animated")
	/*transitionEvent && logo.addEventListener(transitionEvent, function() {
		console.log('Transition complete!  This is the callback, no library needed!');
	});*/
	//TODO 
	setTimeout(function(){logo.style.display = "none";logoed = true;}, 1000)
}

// Scrolling

function reApplyScrollPagesSizes(){
	var width = $(window).width()
	var height = $(window).height()
	$(".scroll-page").get().forEach(function(spage){
		spage.style.height = height + "px"
	})
	
	if(logoed) scrollTo(getScrollSnapId(), 0, true)
}

//$(function() {
//	reApplyScrollPagesSizes()
//	$(window).resize(reApplyScrollPagesSizes);
//});

// Snapping

const scrollSnapTime = 500
const scrollSnapParam = "snap"
var scrolling = false

function getScrollSnapId(){
//	return scrollSnapId
	return Number(getUrlQueryParam(scrollSnapParam)) || 0
}

function setScrollSnapId(snap){
	setUrlQueryParam(scrollSnapParam, snap)
}

function getScrollSnapPoints(){
	return $(".scroll-snap").get()
}
	
function preventDefault(e){
	e = e || window.event;
	if(e.preventDefault) e.preventDefault();
	e.returnValue = false;  
}

window.onwheel = window.onmousewheel = function(event){
	preventDefault(event)
	scrollTo(getScrollSnapId() + (event.deltaY > 0 ? 1 : -1), scrollSnapTime, false)
}

window.ontouchmove = function(event){
	preventDefault(event)
	scrollTo(getScrollSnapId() + (event.deltaY > 0 ? 1 : -1), scrollSnapTime, false)
}

// left: 37, up: 38, right: 39, down: 40,
// spacebar: 32, pageup: 33, pagedown: 34, end: 35, home: 36
var keys = {38: -1, 40: +1, 32: +1, 34: +1, 33: -1, 35: Number.POSITIVE_INFINITY, 36:Number.NEGATIVE_INFINITY};
window.onkeydown = function(event){
	var offset = keys[event.keyCode]
	if(offset != undefined){
		preventDefault(event)
		scrollTo(getScrollSnapId() + offset, scrollSnapTime, false)
	}
}

function scrollTo(id, time, force){
	if(!logoed) return logoem();
	
	if(scrolling && !force) return;
	var snaps = getScrollSnapPoints()
	id = id.clamp(0, snaps.length-1)
	if(id == getScrollSnapId() && !force) return;
	
	scrolling = true
	$('html, body').animate({
		scrollTop: $(snaps[id]).offset().top
	}, time, "swing", function(){
		setScrollSnapId(id)
		scrolling = false
		$(window).trigger("scroll-snap-end", id)
	});
}

// Contents

function getContents(){
	return $(".contents")
}

function genContents(typeClass, contentFromPage, onComplete, force = false, fadeOut = 150, fadeIn = 150){
	var contents = getContents()
	if(!force && contents.hasClass(typeClass)) return;
	var onFadeOut = function(){
		contents.removeClass("interpunct").removeClass("text").addClass(typeClass)
		contents.html("")
		$(".scroll-page").get().forEach(function(spage, index){
			contents.html(function(i, ohtml){
				return ohtml + "<tr><td class=\"contents-element\">" + contentFromPage($(spage), index) + "</td></tr>"
			})
		})
		if(fadeIn > 0) contents.fadeIn(fadeIn, onComplete); else onComplete();
	}
	if(fadeOut > 0) contents.fadeOut(fadeOut, onFadeOut); else onFadeOut();
}

function genInterpunctContents(force, fadeOut, fadeIn){
	genContents("interpunct", function(spage){return "â€¢";}, function(){
		$(".contents-element").get().forEach(function(aelem, i){
			$(aelem).click(genTextContents)
			if(i == getScrollSnapId()) $(aelem).toggleClass("contents-element-current")
		})
	}, force, fadeOut, fadeIn)
}

function genTextContents(force, fadeOut, fadeIn){
	genContents("text", function(spage){return spage.attr("contents-title");}, function(){
		$(".contents-element").get().forEach(function(aelem, i){
			var elem = $(aelem)
			elem.hover(function(){
				elem.css("text-decoration", "underline")
			}, function(){
				elem.css("text-decoration", "none")
			})
			elem.on('click touchend', function(e){
				scrollTo(i, scrollSnapTime, false)
				if(e.type == "touchend") genInterpunctContents()
			})
			if(i == getScrollSnapId()) elem.toggleClass("contents-element-current")
		})
	}, force, fadeOut, fadeIn)
}

function reposContents(){
	getContents().css("top", (($(window).height() - getContents().height())/2) + "px")
}

$(function() {
	genInterpunctContents()
	reposContents()
	$(window).resize(reposContents)
	getContents().hover(function(){genTextContents()}, function(){genInterpunctContents()})
});

$(window).on("scroll-snap-end", function(){
	if(getContents().hasClass("text")) genTextContents(true, 0, 0);
	else genInterpunctContents(true, 0, 0);
});

</script>
<head>
<meta charset="utf-8">
<title>index</title>
<link href="index.css" rel="stylesheet" type="text/css">
</head>

<body>
<table class="contents"></table>
<div class="page-scroller">
<!--<div class="logo scroll-page" onClick="onLogoClick(this)"></div>-->
<div class="scroll-page scroll-snap" contents-title="A tag 1">This is a text!</div>
<div class="scroll-page scroll-snap" contents-title="A tag first">This is a first scroll text!</div>
<div class="scroll-page scroll-snap" contents-title="A tag 2st">This is a second scroll text!</div>
</div>
</body>
</html>
